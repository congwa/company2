{
    "version": 3,
    "sources": [
        "../../../src/admin/controller/goods.js"
    ],
    "names": [
        "Base",
        "require",
        "module",
        "exports",
        "indexAction",
        "page",
        "get",
        "size",
        "name",
        "model",
        "data",
        "where",
        "order",
        "countSelect",
        "success",
        "infoAction",
        "id",
        "find",
        "storeAction",
        "isPost",
        "values",
        "post",
        "galleryModel",
        "db",
        "attributeModel",
        "startTrans",
        "is_on_sale",
        "is_new",
        "is_hot",
        "is_delete",
        "v",
        "update",
        "add",
        "gallery_list",
        "length",
        "goods_id",
        "delete",
        "list",
        "map",
        "url",
        "index",
        "img_url",
        "img_desc",
        "sort_order",
        "addMany",
        "goods_attribute",
        "a_list",
        "item",
        "console",
        "log",
        "commit",
        "e",
        "rollback",
        "fail",
        "destoryAction",
        "limit",
        "infogoodsAction",
        "field",
        "join",
        "select",
        "galleryinfoAction"
    ],
    "mappings": "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",
    "file": "../../../src/admin/controller/goods.js",
    "sourcesContent": [
        "const Base = require('./base.js');\n\nmodule.exports = class extends Base {\n  /**\n   * index action\n   * @return {Promise} []\n   */\n  async indexAction() {\n    const page = this.get('page') || 1;\n    const size = this.get('size') || 10;\n    const name = this.get('name') || '';\n\n    const model = this.model('goods');\n    const data = await model.where({name: ['like', `%${name}%`]}).order(['id DESC']).page(page, size).countSelect();\n\n    return this.success(data);\n  }\n\n  async infoAction() {\n    const id = this.get('id');\n    const model = this.model('goods');\n    const data = await model.where({id: id}).find();\n\n    return this.success(data);\n  }\n\n  async storeAction() {\n    if (!this.isPost) {\n      return false;\n    }\n\n    const values = this.post();\n    const id = this.post('id');\n    const model = this.model('goods');\n    const galleryModel = this.model('goods_gallery').db(model.db());\n    const attributeModel = this.model('goods_attribute').db(model.db());\n    try{\n      //添加goods表\n\n      await model.startTrans();\n      values.is_on_sale = values.is_on_sale ? 1 : 0;\n      values.is_new = values.is_new ? 1 : 0;\n      values.is_hot = values.is_hot ? 1 : 0;\n      values.is_delete = values.is_delete ? 1 : 0;  // 0代表上架  1代表下架\n      var v;\n      if (id > 0) {\n        // console.log('***************1');\n        await model.where({id: id}).update(values);\n        // console.log('***************71');\n      } else {\n        delete values.id;\n        // console.log('***************72');\n        v = await model.add(values);\n        id = v;\n      }\n      // console.log('-------------------------',id);\n      //添加goods_gallery\n      const gallery_list = values['gallery'];\n\n      if(gallery_list && gallery_list.length >0){\n        // console.log('***************73');\n        await galleryModel.where({goods_id:id}).delete();\n        const list = gallery_list.map((url ,index)=> {\n          return {img_url:url,goods_id:id,img_desc:'',sort_order:index}\n        })\n\n        await galleryModel.addMany(list);\n      }\n\n\n      //添加商品属性\n      const goods_attribute = values['attribute'];\n\n      if( goods_attribute && goods_attribute.length > 0 ) {\n        // console.log('***************74');\n        await attributeModel.where({goods_id:id}).delete();\n        const a_list = goods_attribute.map(item => {\n          item.goods_id = id;\n          return item;\n        })\n        await attributeModel.addMany(a_list);\n\n      }\n      console.log('***************7');\n      await model.commit();\n      return this.success(values);\n    }catch(e){\n      console.log('***************',e);\n\n      await model.rollback();\n      return  this.fail(1002,e);\n    }\n\n\n\n\n\n\n  }\n\n\n  async destoryAction() {\n    const id = this.post('id');\n    await this.model('goods').where({id: id}).limit(1).delete();\n    // TODO 删除图片\n\n    return this.success();\n  }\n\n  async infogoodsAction() {\n    const id = this.post('id') || this.get('id');\n\n    const model = this.model('goods_attribute');\n    const data = await model.field('attribute_id,value,attribute_category_id').where({goods_id: id}).join('nideshop_attribute ON nideshop_attribute.id=nideshop_goods_attribute.attribute_id').select();\n    return this.success(data);\n  }\n\n  async galleryinfoAction() {\n    const id = this.post('id');\n    const data = await this.model('goods_gallery').field('img_url').where({goods_id: id}).select();\n    // TODO 删除图片\n\n    return this.success(data);\n  }\n};\n"
    ]
}